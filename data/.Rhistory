alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
n_sub
n_out
alpha1
alpha0_raw
alpha0
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
alpha0
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
alpha0_raw
alpha0_raw[n_sub, n_out]
alpha0[n_sub, n_out]
alpha0[n_sub, N_out]
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
alpha0 = matrix(0, ncol = N_out, nrow = N_sub)
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
alpha0
for(n_sub in 1:N_sub){
for(n_out in 1:(N_out-1)){
alpha0[n_sub, n_out] = alpha0_raw[n_sub, n_out];
}
alpha0[n_sub, N_out] = -sum(alpha0_raw[n_sub,]);
}
source('~/Desktop/mdonohue-ltjmm-5ef87d844807/R/ltjmm.R', echo=TRUE)
dd2 <- simulate.ltjmm(setup,
beta = beta,
gamma = gamma,
sigma_diag = sigma_alpha,
sigma_delta = sigma_delta,
sigma_y = sigma_y,
seed = 201610014)
dd2
dd$Y <- dd2$y
dd$Q <- dd$Z <- dd$Z2 <- NA
for(oc in unique(dd$outcome)){
subs <- dd$outcome == oc
ecdf.fun <- ecdf(dd$Y[subs])
dd$Q[subs] <- ecdf.fun(dd$Y[subs])
dd$Z2[subs] <- qnorm(dd$Q[subs])
dd$Z[subs] <- scale(dd$Y[subs])
}
fit <- stan(file = file.path(.libPaths()[1], "ltjmm", "stan", "ltjmm.stan"),
seed = rng_seed,
data = ltjmm(Y ~ year |
1 | # fixed effects direct on outcome
id | outcome,
data = dd)$data,
pars = c('beta', 'delta', 'alpha0', 'alpha1', 'gamma',
'sigma_alpha0', 'sigma_alpha1', "sigma_delta", 'sigma_y', 'log_lik'),
open_progress = FALSE, chains = 2, iter = 2000,
warmup = 1000, thin = 1, cores = 2)
.libPaths()[1]
fit
subjects
fit$`beta[1,1]`
fit$beta[1,1]
fit$beta
fit$`delta[1]`
fit$`alpha0[395,4]`
fit[["delta[1]"]]
fit[["delta"]]
fit
delta(fit)
fit$`beta[1,1]`
fit beta[1,1]`
fit
par_dims(fit)
fit@par_dims
getwd()
setwd("/Users/MonicaW/Documents/GitHub/LWPR/")
setwd("/Users/MonicaW/Documents/GitHub/LWPR/data")
X0 = as.matrix(read_table("X1a.txt", col_names = F))
Y0 = as.matrix(read_table("Y5T.txt", col_names = F))[, 4+5*(t-1)]
Y0
t
t = 1
Y0 = as.matrix(read_table("Y5T.txt", col_names = F))[, 4+5*(t-1)]
Y0
Y0 = as.matrix(read_table("Y5T.txt", col_names = F))[, 4+5*(c(1,2,3)-1)]
Y0
apply(Y0, 2, function(x) x[is.na(x)])
apply(Y0, 2, function(x) x[x<0])
apply(Y0, 2, function(x) x[x<0] = NA x)
apply(Y0, 2, function(x) {x[x<0] = NA
x})
Y0 = apply(Y0, 2, function(x) {x[x<0] = NA
x})
subjects
subject_time_outcome
expand.grid(id = 1:n, visit = c(1, 2, 3, 4), outcome = 1:p)
n = nrow(X0)
n
sample(n,200)
X = X0[sample(n,200),]
X
Y = Y0[id,]
label0 = as.ordered(read_table("label1.txt", col_names = F)$X1)
dd$apoe
Xs = X0[, 1:186]
Xs.med.list = lapply(levels(label0), function(x) apply(Xs[label0 == x, ], 2, function(y) median(y, na.rm = T)))
Xs.missing = is.na(Xs)
for (i in 1:nrow(Xs)){
ip.med = Xs.med.list[[as.numeric(label0[i])]]
Xs[i, Xs.missing[i, ]] = ip.med[Xs.missing[i, ]]
}
n = nrow(X0)
id = sample(n,200)
X = Xs[id,]
Y = Y0[id,]
X
Y
subject_time_outcome = expand.grid(id = 1:n, visit = c(1, 2, 3, 4), outcome = 1:p)
subject_time_outcome
subject_time_outcome = expand.grid(id = id, visit = c(1, 2, 3, 4), outcome = 1:p)
subject_time_outcome
Y
X
subject_time_outcome
is.na(Y[i,])
i  =1
is.na(Y[i,])
Y[i,][!is.na(Y[i,])]
is.matrix(Y)
mylist = list()
for (i in 1:n){
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
mylist[[i]] = cbind(year, outcome)
}
Y
n
n = nrow(X)
mylist = list()
for (i in 1:n){
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
mylist[[i]] = cbind(year, outcome)
}
mylist
mylist = list()
for (i in 1:n){
id = id[i]
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
mylist[[i]] = cbind(id,year, outcome)
}
mylist
id
id = sample(n,200)
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
mylist = list()
for (i in 1:n){
id = id[i]
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
mylist[[i]] = cbind(id,year, outcome)
}
mylist
id
id = sample(805,200)
id
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
mylist = list()
for (i in 1:n){
id = id[i]
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
mylist[[i]] = cbind(id,year, outcome)
}
mylist
id[i]
id
id = sample(805,200)
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
mylist = list()
mylist = list()
for (i in 1:n){
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
mylist[[i]] = cbind(id = id[i],year, outcome)
}
mylist
do.call(rbind, mylist)
subjects
library(dplyr)
id = sample(805,200)
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
Ylist = list()
for (i in 1:n){
outcome = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
Ylist[[i]] = cbind(id = id[i],year, outcome)
}
do.call(rbind, Ylist)
id_year_outcome = do.call(rbind, Ylist)
id_year_outcome
id_X = cbind(id, X)
id_X
right_join(id_X, id_year_outcome, by = 'id')
id_X
id_X = as.data.frame(cbind(id, X))
id_X
id_X
id_X
id_year_outcome = as.data.frame(do.call(rbind, Ylist))
right_join(id_X, id_year_outcome, by = 'id')
subjects
dd
rng_seed <- 20161001
set.seed(rng_seed)
n <- 400 # subjects
p <- 4 # outcomes
t <- 4 # time points
subjects <- data.frame(id = 1:n,
age.0 = rnorm(n, 75, 5),
apoe = sample(c(0, 1), size = n, replace = TRUE))
subject_time_outcome <- expand.grid(id = 1:n, visit = c(1, 2, 3, 4), outcome = 1:p)
subject_time_outcome <- subject_time_outcome[order(subject_time_outcome$id,
subject_time_outcome$outcome),]
for(i in 1:n){
time.year <- sort(runif(t, 0, 10)) # t number of time points
for(j in 1:p){
subject_time_outcome$year[(subject_time_outcome$id == i) &
(subject_time_outcome$outcome == j)] <- time.year
}
}
dd <- right_join(subjects, subject_time_outcome, by = 'id')
dd
dd$Y <- NA
dd0 <- dd
setup <- ltjmm(Y ~ year | 1 | id | outcome, data = dd)
setup
Y.list = list()
for (i in 1:n){
Y.tmp = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
Y.list[[i]] = cbind(id = id[i], year, Y = Y.tmp)
}
id = sample(805,200)
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
Y.list = list()
id_year_Y.list = list()
for (i in 1:n){
Y.tmp = Y[i,][!is.na(Y[i,])]
year = c(1,2,3)[!is.na(Y[i,])]
id_year_Y.list[[i]] = cbind(id = id[i], year, Y = Y.tmp)
}
id_year_Y = as.data.frame(do.call(rbind, id_year_Y.list))
id_year_Y
id_X = as.data.frame(cbind(id, X))
id_X
id_year_Y_outcome = data.frame(id_year_Y, outcome = 1)
id_year_Y_outcome
id_X = as.data.frame(cbind(id, X))
right_join(id_X, id_year_outcome, by = 'id')
right_join(id_X, id_year_Y_outcome, by = 'id')
dd = right_join(id_X, id_year_Y_outcome, by = 'id')
dd
right_join(subjects, subject_time_outcome, by = 'id')
id = sample(805,200)
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
id_year_Y.list = list()
for (i in 1:n){
Y.tmp = Y[i,][!is.na(Y[i,])]
year = c(0,1,2)[!is.na(Y[i,])]
id_year_Y.list[[i]] = cbind(id = id[i], year, Y = Y.tmp)
}
id_year_Y = as.data.frame(do.call(rbind, id_year_Y.list))
id_year_Y_outcome = data.frame(id_year_Y, outcome = 1)
id
X
Y
n
id_year_Y.list = list()
for (i in 1:n){
Y.tmp = Y[i,][!is.na(Y[i,])]
year = c(0,1,2)[!is.na(Y[i,])]
id_year_Y.list[[i]] = cbind(id = id[i], year, Y = Y.tmp)
}
do.call(rbind, id_year_Y.list)
id_year_Y.list
id_year_Y = as.data.frame(do.call(rbind, id_year_Y.list))
id_year_Y.list
id_year_Y.list[[1]]
sapply(id_year_Y.list, ncol)
seq(1,200)[sapply(id_year_Y.list, ncol)==1]
id_year_Y.list[[93]]
seq(1,200)[id == 31]
i = 93
Y[i,][!is.na(Y[i,])]
!is.na(Y[i,]
)
Y0
apply(Y0, 1, is.na)
Y0 = apply(Y0, 1, !is.na)
apply(Y0, 1, is.na)
is.na(Y0[1,])
Y0
is.na(Y0[1,])
product(is.na(Y0[1,]))
prod(is.na(Y0[1,]))
prod(!is.na(Y0[1,]))
apply(Y0, 1, function(row) prod(!is.na(row)))
Y0
apply(Y0, 1, function(row) prod(!is.na(row)))
apply(Y0, 1, function(row) prod(is.na(row)))
apply(Y0, 1, function(row) !prod(is.na(row)))
apply(Y0, 1, function(row) !prod(is.na(row)))
Y0 = Y0[apply(Y0, 1, function(row) !prod(is.na(row))), ]
Xs = X0[, 1:186]
Xs.med.list = lapply(levels(label0), function(x) apply(Xs[label0 == x, ], 2, function(y) median(y, na.rm = T)))
Xs.missing = is.na(Xs)
allnan = apply(Y0, 1, function(row) !prod(is.na(row)))
Y0 = apply(Y0, 2, function(x) {x[x<0] = NA
x})
setwd("/Users/MonicaW/Documents/GitHub/LWPR/data")
X0 = as.matrix(read_table("X1a.txt", col_names = F))
Y0 = as.matrix(read_table("Y5T.txt", col_names = F))[, 4+5*(c(1,2,3)-1)]
label0 = as.ordered(read_table("label1.txt", col_names = F)$X1)
setwd("/Users/MonicaW/Documents/GitHub/LWPR/data")
X0 = as.matrix(read_table("X1a.txt", col_names = F))
Y0 = as.matrix(read_table("Y5T.txt", col_names = F))[, 4+5*(c(1,2,3)-1)]
label0 = as.ordered(read_table("label1.txt", col_names = F)$X1)
Y0 = apply(Y0, 2, function(x) {x[x<0] = NA
x})
allnan = apply(Y0, 1, function(row) !prod(is.na(row)))
Y0 = Y0[allnan, ]
Xs = X0[allnan, 1:186]
Xs.med.list = lapply(levels(label0), function(x) apply(Xs[label0 == x, ], 2, function(y) median(y, na.rm = T)))
label0 = label0[allnan]
Xs.med.list = lapply(levels(label0), function(x) apply(Xs[label0 == x, ], 2, function(y) median(y, na.rm = T)))
Xs.missing = is.na(Xs)
for (i in 1:nrow(Xs)){
ip.med = Xs.med.list[[as.numeric(label0[i])]]
Xs[i, Xs.missing[i, ]] = ip.med[Xs.missing[i, ]]
}
id = sample(805,200)
X = Xs[id,]
Y = Y0[id,]
n = nrow(X)
id_year_Y.list = list()
for (i in 1:n){
Y.tmp = Y[i,][!is.na(Y[i,])]
year = c(0,1,2)[!is.na(Y[i,])]
id_year_Y.list[[i]] = cbind(id = id[i], year, Y = Y.tmp)
}
id_year_Y = as.data.frame(do.call(rbind, id_year_Y.list))
id_year_Y_outcome = data.frame(id_year_Y, outcome = 1)
id_X = as.data.frame(cbind(id, X))
dd = right_join(id_X, id_year_Y_outcome, by = 'id')
dd
setup <- ltjmm(Y ~ year | .-Y-outcome-year-id | id | outcome, data = dd)
setup
n
fit <- stan(file = file.path(.libPaths()[1], "ltjmm", "stan", "ltjmm.stan"),
seed = rng_seed,
data = setup$data,
pars = c('beta', 'delta', 'alpha0', 'alpha1', 'gamma',
'sigma_alpha0', 'sigma_alpha1', "sigma_delta", 'sigma_y', 'log_lik'),
open_progress = FALSE, chains = 2, iter = 2000,
warmup = 1000, thin = 1, cores = 2)
fit <- stan(file = file.path(.libPaths()[1], "ltjmm", "stan", "ltjmm.stan"),
seed = rng_seed,
data = setup$data,
pars = c('beta', 'delta', 'alpha0', 'alpha1', 'gamma',
'sigma_alpha0', 'sigma_alpha1', "sigma_delta", 'sigma_y', 'log_lik'),
open_progress = FALSE, chains = 2, iter = 2000,
warmup = 1000, thin = 1, cores = 2)
fit
save.image("~/Documents/GitHub/LWPR/data/ltjmmfit.RData")
load("/Users/MonicaW/Documents/GitHub/LWPR/simulation/parameter/diag_cov/sim_par21.RData")
View(Sigma_1)
View(Sigma_c)
View(Sigma_c)
View(Sigma_0)
load("/Users/MonicaW/Documents/GitHub/LWPR/simulation/parameter/non_diag_cov/sim_par31.RData")
w
setup
library(dplyr)
library(readr)
library(ltjmm)
library(caret)
library(doParallel)
library(energy)
setwd("/Users/MonicaW/Documents/GitHub/LWPR/data")
X0 = as.matrix(read_table("X1a.txt", col_names = F))
Y0 = as.matrix(read_table("Y5T.txt", col_names = F))[, 4+5*(c(1,2,3)-1)]
label0 = as.ordered(read_table("label1.txt", col_names = F)$X1)
Y0 = apply(Y0, 2, function(x) {x[x<0] = NA
x})
allnan = apply(Y0, 1, function(row) !prod(is.na(row)))
Y0 = Y0[allnan, ]
Y0 = log(Y0+1)
Xs = X0[allnan, 1:186]
label0 = label0[allnan]
Xs.med.list = lapply(levels(label0), function(x) apply(Xs[label0 == x, ], 2, function(y) median(y, na.rm = T)))
Xs.missing = is.na(Xs)
for (i in 1:nrow(Xs)){
ip.med = Xs.med.list[[as.numeric(label0[i])]]
Xs[i, Xs.missing[i, ]] = ip.med[Xs.missing[i, ]]
}
n = nrow(Xs)
p = ncol(Xs)
set.seed(myseed)
idtrain = unlist(createDataPartition(label0, times = 1, p = 3/4))
idtest = (1:n)[-idtrain]
id_all = seq(1,n)
X1.mean = apply(Xs[idtrain,], 2, mean)
X1.sd = apply(Xs[idtrain,], 2, sd)
X1.sd = sapply(X1.sd, function(x) ifelse(x<1e-5, 1, x))
Xs[idtrain,] = t(apply(Xs[idtrain,], 1, function(x) (x - X1.mean)/X1.sd))
Xs[idtest,] = t(apply(Xs[idtest,], 1, function(x) (x - X1.mean)/X1.sd))
X.interaction.list = list()
k = 0
for (i in 1:p){
for (j in 1:p){
if (i < j){
k = k+1
X.interaction.list[[k]] = Xs[,i]*Xs[,j]
}
}
}
X.interaction = do.call(cbind, X.interaction.list)
X1.interaction.mean = apply(X.interaction[idtrain,], 2, mean)
X1.interaction.sd = apply(X.interaction[idtrain,], 2, sd)
X1.interaction.sd = sapply(X1.interaction.sd, function(x) ifelse(x<1e-5, 1, x))
X.interaction[idtrain, ]= t(apply(X.interaction[idtrain, ], 1, function(x) (x - X1.interaction.mean)/X1.interaction.sd))
X.interaction[idtest, ] = t(apply(X.interaction[idtest, ], 1, function(x) (x - X1.interaction.mean)/X1.interaction.sd))
X.plus.inter = cbind(Xs, X.interaction)
p_dc = 200
cl = makeCluster(4) # number of cores you can use
registerDoParallel(cl)
dc.vec = foreach(col_ix = 1:ncol(X.plus.inter[idtrain, ]), .packages = "energy", .combine = "c") %dopar% {
dcor(Y0[idtrain], X.plus.inter[idtrain,][,col_ix])
}
stopCluster(cl)
X.selected.feature.id = order(dc.vec, decreasing = TRUE)[1:p_dc]
X.selected.feature = X.plus.inter[, X.selected.feature.id]
feature.ncol = ncol(X.selected.feature)
colnames(X.selected.feature) = as.character(seq(1, feature.ncol))
id_year_Y.list = list()
for (i in 1:n){
Y.tmp = Y0[i,][!is.na(Y0[i,])]
year = c(0,1,2)[!is.na(Y0[i,])]
id_year_Y.list[[i]] = cbind(id = id_all[i], year, Y = Y.tmp)
}
id_year_Y = as.data.frame(do.call(rbind, id_year_Y.list))
id_year_Y_outcome = data.frame(id_year_Y, outcome = 1)
id_X = as.data.frame(cbind(id = id_all, X.selected.feature))
dd = right_join(id_X, id_year_Y_outcome, by = 'id')
setup <- ltjmm(Y ~ year | .-Y-outcome-year-id | id | outcome, data = dd[dd$id %in% idtrain,])
fit <- stan(file = file.path(.libPaths()[1], "ltjmm", "stan", "ltjmm.stan"),
seed = rng_seed,
data = setup$data,
pars = c('beta', 'delta', 'alpha0', 'alpha1', 'gamma',
'sigma_alpha0', 'sigma_alpha1', "sigma_delta", 'sigma_y', 'log_lik'),
open_progress = FALSE, chains = 2, iter = 2000,
warmup = 1000, thin = 1, cores = 2)
dd[dd$id %in% idtrain,]
fit <- stan(file = file.path(.libPaths()[1], "ltjmm", "stan", "ltjmm.stan"),
data = setup$data,
pars = c('beta', 'delta', 'alpha0', 'alpha1', 'gamma',
'sigma_alpha0', 'sigma_alpha1', "sigma_delta", 'sigma_y', 'log_lik'),
open_progress = FALSE, chains = 2, iter = 2000,
warmup = 1000, thin = 1, cores = 2)
load("/Users/MonicaW/Documents/GitHub/LWPR/try_ltjmm.RData")
pairs()
